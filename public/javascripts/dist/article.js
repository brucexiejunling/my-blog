/*! blog 2014-08-28 */
function loadArticleById(a){$.post("/load-article/",{aid:articleId},function(b){""===b.error&&($("div.main").html(b.html),a&&a())})}function listenManageArticleBtnsClickEvent(){$("div.manage-article span.edit-article").click(editArticle),$("div.manage-article span.delete-article").click(function(){confirm("删除该文章？")&&deleteArticle()})}function listenCommentBtnClickEvent(){var a=13;$("div.comment-editor textarea").keydown(function(b){var c=b||window.event;c.ctrlKey&&c.keyCode===a&&validate()&&canSendComment&&(canSendComment=!1,saveNewComment())}),$("div.comment-edit-area button.send-btn").click(function(){validate()&&saveNewComment()})}function listenDeleteCommentBtnClickEvent(){$("li.comment-item span.delete-comment").click(function(){if(confirm("删除该评论？")){var a=$(this).parent().attr("id");deleteComment(a)}})}function editArticle(){location.href="/edit/"+articleId}function deleteArticle(){$.ajax({type:"DELETE",url:"/delete-article/"+articleId}).done(function(a){""===a.error?(alert("删除成功!"),location.href=$("div.navigator a.article-type").attr("href")):alert("删除失败!")})}function validate(){var a=!1,b=!1,c=!1,d=$.trim($("div.username-input input").val());if(!d)return alert("请输入您的昵称!"),!1;a=!0;var e=$.trim($("div.email-input input").val()),f=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;if(!f.test(e))return alert("请输入合法的邮箱地址!"),!1;b=!0;var g=$.trim($("textarea").val());return g.length>0&&g.length<140?(c=!0,a&&b&&c):(alert(g?"评论字数超出限制!":"请输入评论内容!"),!1)}function saveNewComment(){var a=$.trim($("div.username-input input").val()),b=$.trim($("div.email-input input").val()),c=escapeHtml($("textarea").val());$.post("/comment/",{username:a,email:b,content:c,aid:articleId},function(b){canSendComment=!0,""===b.error?(alert("评论成功!"),$("textarea").val(""),prependNewCommentItem(b.comment._id,a,new Date,c),updateCommentNum(1)):alert("评论发送失败!")})}function prependNewCommentItem(a,b,c,d){var e=c.getFullYear(),f=c.getMonth()+1>10?c.getMonth()+1:"0"+(c.getMonth()+1),g=c.getDate()>10?c.getDate():"0"+c.getDate(),h=c.getHours()>10?c.getHours():"0"+c.getHours(),i=c.getMinutes()>10?c.getMinutes():"0"+c.getMinutes(),j=e+"-"+f+"-"+g+" "+h+":"+i,k=$('<li class="comment-item"></li>'),l=$('<span class="username">@'+b+"</span>"),m=$('<p class="comment-content">'+d+"</p>"),n=$('<span class="comment-date">'+j+"</span>");if(k.append(l).append(n).append(m).attr("id",a),$("div.manage-article")[0]){var o=$('<span class="delete-comment">删除</span>');o.click(function(){confirm("删除该评论？")&&deleteComment(a)}),k.append(o)}$("ul.comment-list").prepend(k)}function deleteComment(a){$.ajax({type:"DELETE",url:"/delete-comment/"+a}).done(function(b){b.error?alert("删除失败!"):(alert("删除成功!"),$("#"+a).remove(),updateCommentNum(-1))})}function updateCommentNum(a){var b=$("div.comment-title span.comment-num");b.html(parseInt(b.html())+a)}function escapeHtml(a){entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};var b=a.replace(/[&<>"'\/]/g,function(a){return entityMap[a]});return b}function copyText(a){var b=document.createTextRange();b.moveToElementText(a),b.scrollIntoView(),b.select(),b.execCommand("Copy"),b.collapse(!1)}var articleId="",canSendComment=!0;$(function(){articleId=$("div.aid-holder").html(),loadArticleById(function(){var a=$("pre");$.each(a,function(a,b){b.innerHTML=b.innerHTML.replace(/(\/\*.*?\*\/)|(\/\/[^<\n\r]*)/g,function(a){return'<span class="comments">'+a+"</span>"})}),listenManageArticleBtnsClickEvent(),listenCommentBtnClickEvent(),listenDeleteCommentBtnClickEvent()})});